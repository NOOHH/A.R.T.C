<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Selection Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .batch-option {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #ffffff;
        }
        .batch-option:hover:not(.disabled) {
            border-color: #0d6efd;
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
            transform: translateY(-1px);
        }
        .batch-option.selected {
            border-color: #0d6efd;
            background: #f8f9ff;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        }
        .ongoing-indicator {
            font-size: 0.75rem;
            color: #dc3545;
            font-weight: 700;
            margin-left: 8px;
        }
        .status-ongoing {
            background: #fff3cd;
            color: #664d03;
        }
        .status-available {
            background: #d1edff;
            color: #084298;
        }
        .ongoing-warning {
            margin-top: 8px;
            padding: 8px 10px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #664d03;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Enhanced Batch Selection Test</h2>
        
        <div class="row">
            <div class="col-md-6">
                <h4>Program Selection</h4>
                <select id="programSelect" class="form-select" onchange="loadBatches()">
                    <option value="">Select a Program</option>
                    <option value="32">Engineer</option>
                    <option value="33">Culinary</option>
                </select>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h4>Available Batches</h4>
                <div id="batchContainer">
                    <p class="text-muted">Select a program to view available batches</p>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h4>Form Submission Test</h4>
                <form id="testForm" onsubmit="return testFormSubmission(event)">
                    <input type="hidden" name="program_id" id="hidden_program_id">
                    <input type="hidden" name="batch_id" id="hidden_batch_id">
                    
                    <div class="mb-3">
                        <label class="form-label">Test Email:</label>
                        <input type="email" name="email" class="form-control" value="test@example.com" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Test Form Submission</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Ongoing Batch Modal -->
    <div class="modal fade" id="ongoingBatchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Ongoing Batch Warning
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Content will be filled by JavaScript -->
                </div>
                <div class="modal-footer" id="modalFooter">
                    <!-- Buttons will be filled by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedBatchId = null;
        let selectedBatchName = null;

        async function loadBatches() {
            const programSelect = document.getElementById('programSelect');
            const programId = programSelect.value;
            const container = document.getElementById('batchContainer');
            
            document.getElementById('hidden_program_id').value = programId;
            
            if (!programId) {
                container.innerHTML = '<p class="text-muted">Select a program to view available batches</p>';
                return;
            }
            
            container.innerHTML = '<div class="text-center p-3"><i class="bi bi-hourglass-split"></i> Loading batches...</div>';
            
            try {
                const response = await fetch(`/batches/by-program?program_id=${programId}`);
                const batches = await response.json();
                
                console.log('Fetched batches:', batches);
                
                if (batches.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No batches available for this program.</div>';
                    return;
                }
                
                container.innerHTML = batches.map(batch => {
                    const isOngoing = batch.is_ongoing || batch.batch_status === 'ongoing';
                    const availableSlots = batch.available_slots || (batch.max_capacity - batch.current_capacity);
                    
                    return `
                        <div class="batch-option" onclick="selectBatch(${batch.batch_id}, '${batch.batch_name}', '${batch.batch_status}')">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="batch-name fw-bold">
                                    ${batch.batch_name}
                                    ${isOngoing ? '<span class="ongoing-indicator">ðŸ”´ LIVE</span>' : ''}
                                </div>
                                <div class="badge ${isOngoing ? 'status-ongoing' : 'status-available'}">
                                    ${isOngoing ? 'Ongoing' : 'Available'} (${availableSlots} slots)
                                </div>
                            </div>
                            <div class="batch-details">
                                <div class="small text-muted">
                                    <i class="bi bi-calendar-event me-1"></i>
                                    ${isOngoing ? 'Started' : 'Starts'}: ${batch.start_date}
                                    <span class="ms-3">
                                        <i class="bi bi-people me-1"></i>
                                        Students: ${batch.current_capacity}/${batch.max_capacity}
                                    </span>
                                </div>
                                ${isOngoing ? `
                                    <div class="ongoing-warning">
                                        <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                                        This batch has already started - you can still join but will need to catch up
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading batches:', error);
                container.innerHTML = '<div class="alert alert-danger">Error loading batches. Please try again.</div>';
            }
        }
        
        function selectBatch(batchId, batchName, batchStatus) {
            console.log('Selecting batch:', batchId, batchName, batchStatus);
            
            // Remove previous selections
            document.querySelectorAll('.batch-option').forEach(el => el.classList.remove('selected'));
            
            if (batchStatus === 'ongoing') {
                showOngoingBatchModal(batchId, batchName);
                return;
            }
            
            confirmBatchSelection(batchId, batchName);
        }
        
        function showOngoingBatchModal(batchId, batchName) {
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');
            
            modalBody.innerHTML = `
                <div class="alert alert-warning mb-4">
                    <h6 class="alert-heading">
                        <i class="bi bi-clock-history me-2"></i>The batch "${batchName}" has already started
                    </h6>
                    <p class="mb-0">You can still join, but you'll need to catch up with ongoing activities.</p>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-lightbulb me-2"></i>
                    <strong>Recommendation:</strong> Contact the instructor or support team for a catch-up plan before joining.
                </div>
            `;
            
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-warning" onclick="confirmOngoingBatch(${batchId}, '${batchName}')">
                    <i class="bi bi-check-circle me-2"></i>I Understand, Join Anyway
                </button>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('ongoingBatchModal'));
            modal.show();
        }
        
        function confirmOngoingBatch(batchId, batchName) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('ongoingBatchModal'));
            modal.hide();
            confirmBatchSelection(batchId, batchName);
        }
        
        function confirmBatchSelection(batchId, batchName) {
            selectedBatchId = batchId;
            selectedBatchName = batchName;
            
            // Select the batch visually
            event.target.closest('.batch-option').classList.add('selected');
            
            // Update hidden form field
            document.getElementById('hidden_batch_id').value = batchId;
            
            console.log('Batch confirmed:', batchId, batchName);
        }
        
        function testFormSubmission(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            console.log('=== FORM SUBMISSION TEST ===');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            alert('Form submission test completed! Check console for details.');
            return false;
        }
    </script>
</body>
</html>
