<!DOCTYPE html>
<html>
<head>
    <title>Test Batch Loading</title>
    <meta name="csrf-token" content="test-token">
</head>
<body>
    <h1>Test Batch Loading</h1>
    
    <div>
        <label for="programSelect">Program:</label>
        <select id="programSelect" onchange="loadBatchesForProgram(this.value)">
            <option value="">Select Program</option>
            <option value="1">Test Program 1</option>
            <option value="2">Test Program 2</option>
        </select>
    </div>
    
    <div>
        <label for="learningMode">Learning Mode:</label>
        <select id="learning_mode" onchange="loadBatchesForProgram(document.getElementById('programSelect').value)">
            <option value="">Select Mode</option>
            <option value="synchronous">Synchronous</option>
            <option value="asynchronous">Asynchronous</option>
        </select>
    </div>
    
    <div id="batchSelectionContainer" style="display: none; border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
        <h3>Select Batch</h3>
        <div id="batchOptions">
            <!-- Batches will be loaded here -->
        </div>
    </div>

    <script>
    async function loadBatchesForProgram(programId = null) {
        const programSelect = document.getElementById('programSelect');
        const learningMode = document.getElementById('learning_mode')?.value;
        const batchContainer = document.getElementById('batchSelectionContainer');
        const batchOptions = document.getElementById('batchOptions');
        
        console.log('=== loadBatchesForProgram called ===');
        console.log('Program select element:', programSelect);
        console.log('Program selected:', programId || programSelect?.value);
        console.log('Learning mode:', learningMode);
        console.log('Batch container found:', !!batchContainer);
        console.log('Batch options found:', !!batchOptions);
        
        const selectedProgramId = programId || (programSelect ? programSelect.value : null);
        
        // Only show batches for synchronous mode and when a program is selected
        if (!selectedProgramId || learningMode !== 'synchronous') {
            console.log('Hiding batch container - conditions not met');
            console.log('- Program selected:', !!selectedProgramId);
            console.log('- Learning mode is synchronous:', learningMode === 'synchronous');
            
            if (batchContainer) {
                batchContainer.style.display = 'none';
                console.log('Batch container hidden');
            }
            return;
        }
        
        console.log('Loading batches for program ID:', selectedProgramId);
        
        try {
            // Show batch container and loading state
            if (batchContainer) {
                batchContainer.style.display = 'block';
                console.log('Batch container shown');
            }
            if (batchOptions) {
                batchOptions.innerHTML = '<div class="batch-loading" style="text-align:center; padding:20px; color:#666;"><i class="bi bi-hourglass-split"></i> Loading batches...</div>';
            }
            
            const url = `/batches/by-program?program_id=${selectedProgramId}`;
            console.log('Fetching from URL:', url);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            
            if (!response.ok) {
                throw new Error(`Failed to fetch batches: ${response.status} ${response.statusText}`);
            }
            
            const response_data = await response.json();
            console.log('Fetched response:', response_data);
            
            // Handle the response format
            const batches = response_data.batches || response_data || [];
            const auto_create = response_data.auto_create || false;
            const message = response_data.message || '';
            
            if (batchOptions) {
                if (batches.length === 0 || auto_create) {
                    batchOptions.innerHTML = `
                        <div class="no-batches-info" style="padding:20px; background:#e8f4fd; border:2px solid #0066cc; border-radius:12px;">
                            <h5>Auto-Batch Creation Enabled</h5>
                            <p>No active batches available for this program. You can continue with registration.</p>
                        </div>
                    `;
                } else {
                    batchOptions.innerHTML = batches.map(batch => {
                        return `
                            <div class="batch-option" style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; cursor: pointer;" 
                                 onclick="selectBatch(${batch.batch_id}, '${batch.batch_name}')" 
                                 data-batch-id="${batch.batch_id}">
                                <div><strong>${batch.batch_name}</strong></div>
                                <div>Status: ${batch.batch_status}</div>
                                <div>Capacity: ${batch.current_capacity}/${batch.max_capacity}</div>
                                <div>Start Date: ${batch.start_date}</div>
                            </div>
                        `;
                    }).join('');
                }
            }
            
        } catch (error) {
            console.error('Error loading batches:', error);
            if (batchOptions) {
                batchOptions.innerHTML = `
                    <div style="color: red; padding: 10px;">
                        Error loading batches: ${error.message}
                    </div>
                `;
            }
        }
    }
    
    function selectBatch(batchId, batchName) {
        console.log('Batch selected:', batchId, batchName);
        alert(`Selected batch: ${batchName} (ID: ${batchId})`);
    }
    </script>
</body>
</html>
