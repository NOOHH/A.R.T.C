<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variable Scope Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .test-btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Variable Scope Fix Test</h1>
        <p>Testing the fix for "ReferenceError: fileName is not defined" in loadContentInViewer function.</p>
        
        <button class="test-btn" onclick="testVariableScope()">üîç Test Variable Scope Fix</button>
        <button class="test-btn" onclick="testDefaultCase()">üß™ Test Default Case</button>
        <button class="test-btn" onclick="clearResults()">üßπ Clear Results</button>
        
        <div id="test-results"></div>
    </div>

    <script>
        // Test results container
        const resultsContainer = document.getElementById('test-results');

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsContainer.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            resultsContainer.innerHTML = '';
        }

        function testVariableScope() {
            clearResults();
            addResult('üîç Testing variable scope fix for loadContentInViewer function...', 'info');

            try {
                // Test the fixed default case logic
                const testFunction = `
                    function testDefaultCaseFixed() {
                        // Mock content object with various scenarios
                        const testCases = [
                            {
                                name: "Default case with attachment",
                                content: {
                                    content_type: 'document', // This will trigger default case
                                    attachment_path: '["test.pdf", "image.jpg"]',
                                    file_name: '["Document.pdf", "Image.jpg"]',
                                    content_description: 'Test document',
                                    content_url: null
                                }
                            },
                            {
                                name: "Default case with single attachment",
                                content: {
                                    content_type: 'other',
                                    attachment_path: '"single-file.txt"',
                                    file_name: '"SingleFile.txt"',
                                    content_description: 'Single file test'
                                }
                            },
                            {
                                name: "Default case with URL only",
                                content: {
                                    content_type: 'custom',
                                    content_url: 'https://example.com/resource',
                                    content_description: 'URL only test'
                                }
                            },
                            {
                                name: "Default case with no attachments or URL",
                                content: {
                                    content_type: 'empty',
                                    content_description: 'Empty test'
                                }
                            }
                        ];
                        
                        let results = [];
                        
                        testCases.forEach((testCase, index) => {
                            try {
                                const content = testCase.content;
                                let contentHtml = '';
                                const contentType = (content.content_type || 'lesson').toLowerCase();
                                
                                // This is the default case that was causing the error
                                let defaultContentHtml = \`
                                    <div class="content-display">
                                        <h5>\${(content.content_type || 'Content').charAt(0).toUpperCase() + (content.content_type || 'Content').slice(1)} Details</h5>
                                        <p><strong>Description:</strong> \${content.content_description || 'No description'}</p>
                                \`;
                                
                                // Handle attachments for any content type
                                if (content.attachment_path) {
                                    // Check if attachment_path is a JSON array
                                    let attachmentPaths = [];
                                    try {
                                        const parsedPath = JSON.parse(content.attachment_path);
                                        if (Array.isArray(parsedPath)) {
                                            attachmentPaths = parsedPath;
                                        } else {
                                            attachmentPaths = [content.attachment_path];
                                        }
                                    } catch (e) {
                                        // Not JSON, treat as a single file
                                        attachmentPaths = [content.attachment_path];
                                    }
                                    
                                    // Get file names if available
                                    let fileNames = [];
                                    if (content.file_name) {
                                        try {
                                            const parsedNames = JSON.parse(content.file_name);
                                            if (Array.isArray(parsedNames)) {
                                                fileNames = parsedNames;
                                            } else {
                                                fileNames = [content.file_name];
                                            }
                                        } catch (e) {
                                            // Not JSON, treat as a single file name
                                            fileNames = [content.file_name];
                                        }
                                    } else {
                                        // Extract file names from paths
                                        fileNames = attachmentPaths.map(path => path.split('/').pop());
                                    }
                                    
                                    // Create a file preview for each attachment
                                    let filePreview = '';
                                    
                                    for (let i = 0; i < attachmentPaths.length; i++) {
                                        const path = attachmentPaths[i];
                                        const fileUrl = \`/storage/\${path}\`;
                                        const fileName = fileNames[i] || path.split('/').pop();
                                        const fileExtension = fileName.split('.').pop().toLowerCase();
                                        
                                        filePreview += \`<h6 class="mt-3 mb-2">File \${i+1}: \${fileName}</h6>\`;
                                        
                                        if (fileExtension === 'pdf') {
                                            filePreview += 'PDF preview HTML; ';
                                        } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileExtension)) {
                                            filePreview += 'Image preview HTML; ';
                                        } else if (['mp4', 'webm', 'ogg'].includes(fileExtension)) {
                                            filePreview += 'Video preview HTML; ';
                                        } else if (['mp3', 'wav', 'ogg'].includes(fileExtension)) {
                                            filePreview += 'Audio preview HTML; ';
                                        } else {
                                            filePreview += 'Generic file preview HTML; ';
                                        }
                                        
                                        filePreview += \`
                                            <div class="mb-3">
                                                <a href="\${fileUrl}" target="_blank" class="btn btn-primary btn-sm">
                                                    <i class="bi bi-download"></i> Download
                                                </a>
                                                <a href="\${fileUrl}" target="_blank" class="btn btn-outline-primary btn-sm ms-2">
                                                    <i class="bi bi-eye"></i> View in New Tab
                                                </a>
                                            </div>
                                        \`;
                                    } // End of for loop - variables fileName and fileUrl are no longer accessible here
                                    
                                    // FIXED: Removed the problematic code that referenced fileName and fileUrl outside the loop
                                    defaultContentHtml += \`
                                        \${filePreview}
                                    \`;
                                }
                                
                                if (content.content_url) {
                                    defaultContentHtml += \`
                                        <p><strong>URL:</strong> <a href="\${content.content_url}" target="_blank">\${content.content_url}</a></p>
                                        <div class="mt-2">
                                            <a href="\${content.content_url}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-box-arrow-up-right"></i> Open Link
                                            </a>
                                        </div>
                                    \`;
                                }
                                
                                defaultContentHtml += '</div>';
                                contentHtml = defaultContentHtml;
                                
                                results.push(\`Test \${index + 1} (\${testCase.name}): SUCCESS - No variable scope errors\`);
                                
                            } catch (error) {
                                results.push(\`Test \${index + 1} (\${testCase.name}): FAILED - \${error.message}\`);
                                throw error;
                            }
                        });
                        
                        return results;
                    }
                    
                    return testDefaultCaseFixed();
                `;

                // Execute the test
                const results = new Function('return (' + testFunction + ')')()();
                
                addResult('‚úÖ Variable scope fix validation PASSED!', 'success');
                results.forEach(result => {
                    if (result.includes('SUCCESS')) {
                        addResult('‚úÖ ' + result, 'success');
                    } else {
                        addResult('‚ùå ' + result, 'error');
                    }
                });
                
            } catch (error) {
                addResult('‚ùå Variable scope test failed:', 'error');
                addResult('<pre>' + error.message + '</pre>', 'error');
                if (error.stack) {
                    addResult('<pre>' + error.stack + '</pre>', 'error');
                }
            }
        }

        function testDefaultCase() {
            addResult('üß™ Testing specific default case scenarios...', 'info');
            
            try {
                // Test common error scenarios
                const errorTests = [
                    {
                        name: "Using fileName outside loop scope",
                        test: function() {
                            // This would cause the original error
                            let fileName; // This is not defined in outer scope
                            for (let i = 0; i < 2; i++) {
                                fileName = 'file' + i + '.txt';
                            }
                            // fileName is accessible here because it was declared in outer scope
                            return 'fileName after loop: ' + fileName;
                        }
                    },
                    {
                        name: "Using const fileName inside loop scope",
                        test: function() {
                            let result = '';
                            for (let i = 0; i < 2; i++) {
                                const fileName = 'file' + i + '.txt';
                                result += fileName + '; ';
                            }
                            // fileName is NOT accessible here - this would cause ReferenceError
                            // But we're not trying to access it, so this is safe
                            return 'Result: ' + result;
                        }
                    }
                ];
                
                errorTests.forEach((errorTest, index) => {
                    try {
                        const result = errorTest.test();
                        addResult('‚úÖ Test ' + (index + 1) + ' (' + errorTest.name + '): ' + result, 'success');
                    } catch (error) {
                        addResult('‚ùå Test ' + (index + 1) + ' (' + errorTest.name + '): ' + error.message, 'error');
                    }
                });
                
                addResult('üéØ Key Fix Applied:', 'info');
                addResult('‚Ä¢ Removed references to fileName and fileUrl outside the for loop in default case', 'info');
                addResult('‚Ä¢ Variables are now properly scoped within their declaration blocks', 'info');
                addResult('‚Ä¢ The file preview HTML is built correctly within the loop scope', 'info');
                
            } catch (error) {
                addResult('‚ùå Default case test failed: ' + error.message, 'error');
            }
        }

        // Initialize
        window.addEventListener('load', function() {
            addResult('üöÄ Variable Scope Fix Test Ready', 'info');
            addResult('üêõ Original Error: ReferenceError: fileName is not defined at line 2833', 'error');
            addResult('‚úÖ Fix Applied: Removed out-of-scope variable references in default case', 'success');
        });
    </script>
</body>
</html>
