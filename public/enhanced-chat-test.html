<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Chat Test - Real-time with Encryption</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 400px;
            border: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
        }
        .message.sent {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .message.received {
            background-color: #e9ecef;
            color: #333;
            margin-right: auto;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }
        .online { background-color: #28a745; }
        .offline { background-color: #6c757d; }
        .error { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Enhanced Chat Test - Real-time & Encrypted</h5>
                        <div>
                            <span id="connectionStatus" class="badge bg-secondary">Connecting...</span>
                            <span class="status-indicator" id="wsStatus"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="chatContainer" class="chat-container mb-3"></div>
                        <div class="input-group">
                            <input type="number" id="receiverInput" class="form-control" placeholder="Receiver ID (e.g., 2)" style="max-width: 120px;">
                            <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                            <button id="sendButton" class="btn btn-primary" type="button">Send</button>
                        </div>
                        <div class="mt-2 d-flex justify-content-between">
                            <small class="text-muted">User ID: <span id="currentUserId">Not logged in</span></small>
                            <small class="text-muted">Unread: <span id="unreadCount" class="badge bg-danger">0</span></small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Test Controls</h6>
                    </div>
                    <div class="card-body">
                        <button id="loadMessagesBtn" class="btn btn-sm btn-outline-primary mb-2">Load Messages</button>
                        <button id="checkEncryptionBtn" class="btn btn-sm btn-outline-warning mb-2">Check DB Encryption</button>
                        <button id="clearChatBtn" class="btn btn-sm btn-outline-danger mb-2">Clear Chat</button>
                        <hr>
                        <h6>Debug Log</h6>
                        <div id="debugLog" style="height: 250px; overflow-y: auto; font-family: monospace; font-size: 11px; background: #f8f9fa; padding: 10px; border-radius: 4px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include compiled assets -->
    <script src="{{ asset('js/app.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatContainer = document.getElementById('chatContainer');
            const messageInput = document.getElementById('messageInput');
            const receiverInput = document.getElementById('receiverInput');
            const sendButton = document.getElementById('sendButton');
            const connectionStatus = document.getElementById('connectionStatus');
            const wsStatus = document.getElementById('wsStatus');
            const debugLog = document.getElementById('debugLog');
            const currentUserId = document.getElementById('currentUserId');
            const unreadCount = document.getElementById('unreadCount');

            // Simulate user authentication
            const mockUserId = Math.floor(Math.random() * 1000) + 100;
            currentUserId.textContent = mockUserId;
            receiverInput.value = mockUserId === 101 ? 102 : 101; // Default to different user

            function addDebugLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const color = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-dark';
                debugLog.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
                debugLog.scrollTop = debugLog.scrollHeight;
            }

            function updateConnectionStatus(status, type = 'secondary') {
                connectionStatus.textContent = status;
                connectionStatus.className = `badge bg-${type}`;
                wsStatus.className = `status-indicator ${type === 'success' ? 'online' : type === 'danger' ? 'error' : 'offline'}`;
            }

            function addMessage(message, type = 'received') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = `
                    <div>${message.content || message}</div>
                    <small class="opacity-75">${new Date().toLocaleTimeString()}</small>
                `;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Initialize Echo if available
            if (typeof window.Echo !== 'undefined') {
                addDebugLog('‚úÖ Laravel Echo initialized', 'success');
                updateConnectionStatus('Connected', 'success');

                try {
                    // Listen for private messages
                    window.Echo.private(`chat.${mockUserId}`)
                        .listen('MessageSent', (e) => {
                            addDebugLog(`üì® Message received: ${JSON.stringify(e)}`, 'success');
                            addMessage({
                                content: e.message.message,
                                sender: e.message.sender.name
                            }, 'received');
                            updateUnreadCount();
                        });
                    
                    addDebugLog(`üîî Listening on private channel: chat.${mockUserId}`, 'info');
                } catch (error) {
                    addDebugLog(`‚ùå Error setting up private channel: ${error.message}`, 'error');
                }
            } else {
                addDebugLog('‚ùå Laravel Echo not available', 'error');
                updateConnectionStatus('Echo Unavailable', 'danger');
            }

            // Send message function
            async function sendMessage() {
                const message = messageInput.value.trim();
                const receiverId = receiverInput.value.trim();
                
                if (!message || !receiverId) {
                    addDebugLog('‚ùå Message and receiver ID required', 'error');
                    return;
                }

                addDebugLog(`üì§ Sending message to user ${receiverId}: "${message}"`, 'info');

                try {
                    const response = await fetch('/api/chat/session/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            receiver_id: receiverId,
                            message: message
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        addDebugLog(`‚úÖ Message sent successfully (ID: ${data.id})`, 'success');
                        addMessage(message, 'sent');
                        messageInput.value = '';
                    } else {
                        addDebugLog(`‚ùå Failed to send message: ${data.error || data.message}`, 'error');
                    }
                } catch (error) {
                    addDebugLog(`‚ùå Network error: ${error.message}`, 'error');
                }
            }

            // Load messages function
            async function loadMessages() {
                const receiverId = receiverInput.value.trim();
                if (!receiverId) return;

                addDebugLog(`üì• Loading messages with user ${receiverId}`, 'info');

                try {
                    const response = await fetch(`/api/chat/session/messages?with=${receiverId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'include'
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        chatContainer.innerHTML = '';
                        addDebugLog(`‚úÖ Loaded ${data.data.length} messages`, 'success');
                        
                        data.data.forEach(msg => {
                            const type = msg.sender_id == mockUserId ? 'sent' : 'received';
                            addMessage(msg.message, type);
                        });
                    } else {
                        addDebugLog(`‚ùå Failed to load messages: ${data.error}`, 'error');
                    }
                } catch (error) {
                    addDebugLog(`‚ùå Network error: ${error.message}`, 'error');
                }
            }

            // Check database encryption
            async function checkEncryption() {
                addDebugLog('üîç Checking database encryption...', 'info');
                try {
                    const response = await fetch('/api/chat/session/messages?with=' + receiverInput.value, {
                        method: 'GET',
                        headers: {
                            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                        },
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (data.success && data.data.length > 0) {
                        addDebugLog('‚úÖ Messages loaded - encryption/decryption working', 'success');
                        addDebugLog(`üìä Latest message: "${data.data[data.data.length - 1].message}"`, 'info');
                    } else {
                        addDebugLog('‚ÑπÔ∏è No messages found to test encryption', 'info');
                    }
                } catch (error) {
                    addDebugLog(`‚ùå Encryption check failed: ${error.message}`, 'error');
                }
            }

            // Update unread count
            async function updateUnreadCount() {
                try {
                    const response = await fetch('/api/chat/unread-count', {
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        unreadCount.textContent = data.count;
                        unreadCount.className = data.count > 0 ? 'badge bg-danger' : 'badge bg-secondary';
                    }
                } catch (error) {
                    addDebugLog(`‚ùå Failed to update unread count: ${error.message}`, 'error');
                }
            }

            // Event listeners
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
            
            document.getElementById('loadMessagesBtn').addEventListener('click', loadMessages);
            document.getElementById('checkEncryptionBtn').addEventListener('click', checkEncryption);
            document.getElementById('clearChatBtn').addEventListener('click', async function() {
                try {
                    const response = await fetch('/api/chat/session/clear-history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                        },
                        credentials: 'include',
                        body: JSON.stringify({ with: receiverInput.value })
                    });
                    const data = await response.json();
                    if (data.success) {
                        chatContainer.innerHTML = '';
                        addDebugLog('‚úÖ Chat history cleared', 'success');
                    }
                } catch (error) {
                    addDebugLog(`‚ùå Failed to clear chat: ${error.message}`, 'error');
                }
            });

            // Initial setup
            addDebugLog('üöÄ Enhanced chat test initialized', 'success');
            addDebugLog(`üë§ Mock user ID: ${mockUserId}`, 'info');
            updateUnreadCount();
        });
    </script>
</body>
</html>
