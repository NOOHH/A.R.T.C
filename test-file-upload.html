<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; border: 1px solid #ccc; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>üß™ File Upload Debug Test</h1>
    
    <div class="test-section">
        <h2>1. Create Test PDF</h2>
        <button onclick="createTestPDF()">Create Test PDF File</button>
        <div id="pdfStatus"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test File Upload Form</h2>
        <form id="testUploadForm" enctype="multipart/form-data">
            <input type="hidden" name="_token" id="csrfToken">
            <input type="hidden" name="module_name" value="Test Module">
            <input type="hidden" name="module_description" value="Test Description">
            <input type="hidden" name="program_id" value="1">
            <input type="hidden" name="batch_id" value="1">
            <input type="hidden" name="learning_mode" value="Asynchronous">
            
            <div>
                <label for="attachment">Select File:</label>
                <input type="file" name="attachment" id="attachment" accept=".pdf,.doc,.docx,.zip,.png,.jpg,.jpeg">
            </div>
            <br>
            <button type="button" onclick="testFileUpload()">Test Upload</button>
        </form>
        <div id="uploadStatus"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Debug Console</h2>
        <textarea id="debugConsole" rows="20" cols="100" readonly></textarea>
        <br>
        <button onclick="clearDebug()">Clear Debug</button>
    </div>

    <script>
        // Get CSRF token
        fetch('/admin/modules')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const token = doc.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                if (token) {
                    document.getElementById('csrfToken').value = token;
                    log('‚úÖ CSRF token obtained');
                } else {
                    log('‚ùå Failed to get CSRF token');
                }
            })
            .catch(error => {
                log('‚ùå Error getting CSRF token: ' + error.message);
            });

        function log(message) {
            const console = document.getElementById('debugConsole');
            const timestamp = new Date().toLocaleTimeString();
            console.value += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
            console.log(message);
        }

        function clearDebug() {
            document.getElementById('debugConsole').value = '';
        }

        function createTestPDF() {
            log('üîß Creating test PDF...');
            
            // Create a simple PDF-like content (not a real PDF, but for testing)
            const content = `%PDF-1.4
1 0 obj
<<
/Type /Catalog
/Pages 2 0 R
>>
endobj

2 0 obj
<<
/Type /Pages
/Kids [3 0 R]
/Count 1
>>
endobj

3 0 obj
<<
/Type /Page
/Parent 2 0 R
/Resources <<
/Font <<
/F1 4 0 R
>>
>>
/MediaBox [0 0 612 792]
/Contents 5 0 R
>>
endobj

4 0 obj
<<
/Type /Font
/Subtype /Type1
/BaseFont /Times-Roman
>>
endobj

5 0 obj
<<
/Length 44
>>
stream
BT
/F1 18 Tf
0 0 Td
(TEST PDF FILE) Tj
ET
endstream
endobj

xref
0 6
0000000000 65535 f 
0000000010 00000 n 
0000000079 00000 n 
0000000173 00000 n 
0000000301 00000 n 
0000000380 00000 n 
trailer
<<
/Size 6
/Root 1 0 R
>>
startxref
492
%%EOF`;

            const blob = new Blob([content], { type: 'application/pdf' });
            const file = new File([blob], 'test-document.pdf', { type: 'application/pdf' });
            
            // Set the file to the input
            const fileInput = document.getElementById('attachment');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            
            log('‚úÖ Test PDF created and set in file input');
            document.getElementById('pdfStatus').innerHTML = '<span class="success">‚úÖ Test PDF created</span>';
        }

        function testFileUpload() {
            const form = document.getElementById('testUploadForm');
            const fileInput = document.getElementById('attachment');
            const token = document.getElementById('csrfToken').value;
            
            if (!token) {
                log('‚ùå No CSRF token available');
                return;
            }
            
            if (!fileInput.files.length) {
                log('‚ùå No file selected');
                return;
            }
            
            const file = fileInput.files[0];
            log(`üîÑ Testing upload for file: ${file.name} (${file.size} bytes, ${file.type})`);
            
            const formData = new FormData(form);
            
            // Debug FormData
            log('üìù FormData contents:');
            for (let [key, value] of formData.entries()) {
                if (value instanceof File) {
                    log(`  ${key}: ${value.name} (${value.size} bytes, ${value.type})`);
                } else {
                    log(`  ${key}: ${value}`);
                }
            }
            
            // Test upload
            fetch('/admin/modules', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-TOKEN': token,
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                log(`üì° Response status: ${response.status} ${response.statusText}`);
                log(`üì° Response headers: ${JSON.stringify([...response.headers.entries()])}`);
                return response.text();
            })
            .then(text => {
                log(`üì° Response body (first 500 chars): ${text.substring(0, 500)}`);
                
                try {
                    const json = JSON.parse(text);
                    if (json.success) {
                        log('‚úÖ Upload successful!');
                        document.getElementById('uploadStatus').innerHTML = '<span class="success">‚úÖ Upload successful!</span>';
                    } else {
                        log(`‚ùå Upload failed: ${json.message}`);
                        document.getElementById('uploadStatus').innerHTML = `<span class="error">‚ùå Upload failed: ${json.message}</span>`;
                    }
                } catch (e) {
                    if (text.startsWith('<!DOCTYPE')) {
                        log('‚ùå Server returned HTML instead of JSON (likely an error page)');
                        document.getElementById('uploadStatus').innerHTML = '<span class="error">‚ùå Server error (returned HTML)</span>';
                    } else {
                        log('‚ùå Invalid JSON response');
                        document.getElementById('uploadStatus').innerHTML = '<span class="error">‚ùå Invalid response format</span>';
                    }
                }
            })
            .catch(error => {
                log(`‚ùå Network error: ${error.message}`);
                document.getElementById('uploadStatus').innerHTML = `<span class="error">‚ùå Network error: ${error.message}</span>`;
            });
        }

        // Log initial state
        log('üöÄ File upload test page loaded');
    </script>
</body>
</html>
