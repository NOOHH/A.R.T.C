<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Login and Search Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Student Login and Search Test</h2>
        
        <!-- Login Form -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h4>1. Login as Student</h4>
                <form id="loginForm">
                    <div class="mb-3">
                        <input type="email" id="email" class="form-control" placeholder="Student Email" value="">
                    </div>
                    <div class="mb-3">
                        <input type="password" id="password" class="form-control" placeholder="Password" value="">
                    </div>
                    <button type="button" onclick="loginStudent()" class="btn btn-primary">Login</button>
                </form>
                <div id="login-status" class="mt-2"></div>
            </div>
        </div>
        
        <!-- Search Test -->
        <div class="row">
            <div class="col-md-12">
                <h4>2. Test Search</h4>
                <div class="mb-3">
                    <input type="text" id="searchQuery" class="form-control" placeholder="Search query" value="nursing">
                    <button onclick="testSearch()" class="btn btn-success mt-2">Test Search</button>
                </div>
                
                <div id="search-results" class="mt-3">
                    <h5>Search Results:</h5>
                    <pre id="search-output" class="bg-light p-3"></pre>
                </div>
                
                <div id="visual-results" class="mt-3">
                    <h5>Visual Results:</h5>
                    <div id="results-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function loginStudent() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('login-status');
            
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Logging in...';
            
            // Get CSRF token first
            fetch('/unified-login')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const csrfToken = doc.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    
                    // Now login
                    return fetch('/unified-login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken,
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            email: email,
                            password: password,
                            login_type: 'student'
                        })
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusDiv.innerHTML = '<div class="alert alert-success">Login successful!</div>';
                        console.log('Login successful:', data);
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-danger">Login failed: ' + (data.message || 'Unknown error') + '</div>';
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    statusDiv.innerHTML = '<div class="alert alert-danger">Login error: ' + error.message + '</div>';
                });
        }
        
        function testSearch() {
            const query = document.getElementById('searchQuery').value;
            const outputDiv = document.getElementById('search-output');
            const resultsContainer = document.getElementById('results-container');
            
            outputDiv.textContent = 'Searching...';
            resultsContainer.innerHTML = '';
            
            fetch(`/search?query=${encodeURIComponent(query)}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                credentials: 'include' // Include cookies for session
            })
            .then(response => {
                console.log('Search response status:', response.status);
                console.log('Search response headers:', response.headers);
                return response.json();
            })
            .then(data => {
                console.log('Search response data:', data);
                outputDiv.textContent = JSON.stringify(data, null, 2);
                
                if (data.success && data.results && data.results.length > 0) {
                    data.results.forEach(result => {
                        const div = document.createElement('div');
                        div.className = 'card mb-2';
                        div.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">${result.type}: ${result.name}</h5>
                                <p class="card-text">${result.description || 'No description'}</p>
                                <small class="text-muted">Role: ${result.role || 'N/A'}</small>
                                ${result.modules_count !== undefined ? `<br><small>Modules: ${result.modules_count}, Courses: ${result.courses_count}</small>` : ''}
                            </div>
                        `;
                        resultsContainer.appendChild(div);
                    });
                } else {
                    resultsContainer.innerHTML = '<div class="alert alert-info">No results found</div>';
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                outputDiv.textContent = 'Error: ' + error.message;
                resultsContainer.innerHTML = '<div class="alert alert-danger">Search error occurred</div>';
            });
        }
        
        // Check if already logged in
        document.addEventListener('DOMContentLoaded', function() {
            // Try search without login first
            testSearch();
        });
    </script>
</body>
</html>
