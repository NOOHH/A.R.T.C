<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Laravel WebSocket Chat Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 400px;
            border: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
        }
        .message.sent {
            background-color: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .message.received {
            background-color: #e9ecef;
            color: #333;
            margin-right: auto;
        }
        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }
        .online { background-color: #28a745; }
        .offline { background-color: #6c757d; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Laravel WebSocket Chat Test</h5>
                        <small class="text-muted">Connection Status: <span id="connectionStatus" class="badge bg-secondary">Connecting...</span></small>
                    </div>
                    <div class="card-body">
                        <div id="chatContainer" class="chat-container mb-3"></div>
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
                            <button id="sendButton" class="btn btn-primary" type="button">Send</button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">User ID: <span id="currentUserId">Not logged in</span></small>
                            <span class="online-indicator" id="userStatus"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Online Users</h6>
                    </div>
                    <div class="card-body">
                        <div id="onlineUsers">Loading...</div>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-header">
                        <h6>Debug Log</h6>
                    </div>
                    <div class="card-body">
                        <div id="debugLog" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ asset('js/app.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatContainer = document.getElementById('chatContainer');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const connectionStatus = document.getElementById('connectionStatus');
            const debugLog = document.getElementById('debugLog');
            const onlineUsers = document.getElementById('onlineUsers');
            const currentUserId = document.getElementById('currentUserId');
            const userStatus = document.getElementById('userStatus');

            function addDebugLog(message) {
                const timestamp = new Date().toLocaleTimeString();
                debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
                debugLog.scrollTop = debugLog.scrollHeight;
            }

            function updateConnectionStatus(status, type = 'secondary') {
                connectionStatus.textContent = status;
                connectionStatus.className = `badge bg-${type}`;
            }

            function addMessage(message, type = 'received') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = `
                    <div>${message.content || message}</div>
                    <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                `;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // Check if Echo is available
            if (typeof window.Echo !== 'undefined') {
                addDebugLog('Laravel Echo is available');
                updateConnectionStatus('Connected', 'success');

                // Simulate user authentication (replace with actual auth)
                const mockUserId = Math.floor(Math.random() * 1000);
                currentUserId.textContent = mockUserId;
                userStatus.className = 'online-indicator online';

                addDebugLog(`Mock user ID: ${mockUserId}`);

                // Listen for private messages
                try {
                    window.Echo.private(`chat.${mockUserId}`)
                        .listen('MessageSent', (e) => {
                            addDebugLog('Message received via WebSocket');
                            addMessage({
                                content: e.message.message,
                                sender: e.message.sender.name
                            }, 'received');
                        });
                    
                    addDebugLog(`Listening on private channel: chat.${mockUserId}`);
                } catch (error) {
                    addDebugLog(`Error setting up private channel: ${error.message}`);
                }

                // Join presence channel for online users
                try {
                    window.Echo.join('presence-chat')
                        .here((users) => {
                            addDebugLog(`Users currently here: ${users.length}`);
                            updateOnlineUsersList(users);
                        })
                        .joining((user) => {
                            addDebugLog(`User joined: ${user.name || user.id}`);
                            addMessage(`${user.name || user.id} joined the chat`, 'system');
                        })
                        .leaving((user) => {
                            addDebugLog(`User left: ${user.name || user.id}`);
                            addMessage(`${user.name || user.id} left the chat`, 'system');
                        });
                } catch (error) {
                    addDebugLog(`Error joining presence channel: ${error.message}`);
                }

            } else {
                addDebugLog('Laravel Echo is not available - check if assets are compiled');
                updateConnectionStatus('Echo Unavailable', 'danger');
            }

            function updateOnlineUsersList(users) {
                onlineUsers.innerHTML = users.length > 0 
                    ? users.map(user => `
                        <div class="d-flex align-items-center mb-2">
                            <span class="online-indicator online"></span>
                            <span class="ms-2">${user.name || user.id}</span>
                        </div>
                    `).join('')
                    : '<em class="text-muted">No users online</em>';
            }

            // Send message functionality
            function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;

                addDebugLog(`Sending message: ${message}`);
                addMessage(message, 'sent');
                
                // Here you would normally send to server
                // For demo, we'll just simulate a response
                setTimeout(() => {
                    addMessage(`Echo: ${message}`, 'received');
                }, 1000);

                messageInput.value = '';
            }

            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Initial status
            addDebugLog('Chat test page loaded');
            addMessage('Welcome to the Laravel WebSocket Chat Test!', 'system');
        });
    </script>
</body>
</html>
