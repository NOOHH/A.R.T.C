<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Content Upload Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Course Content Upload Test</h1>
        
        <div class="row">
            <div class="col-md-8">
                <form id="courseContentForm" enctype="multipart/form-data">
                    <input type="hidden" name="_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="program_id" value="32">
                    <input type="hidden" name="module_id" value="69">
                    <input type="hidden" name="course_id" value="32">
                    
                    <div class="mb-3">
                        <label for="content_type" class="form-label">Content Type</label>
                        <select class="form-select" id="content_type" name="content_type" required>
                            <option value="lesson">Lesson</option>
                            <option value="assignment">Assignment</option>
                            <option value="pdf">PDF Document</option>
                            <option value="quiz">Quiz</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="content_title" class="form-label">Content Title</label>
                        <input type="text" class="form-control" id="content_title" name="content_title" 
                               value="TEST CONTENT UPLOAD" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="content_description" class="form-label">Description</label>
                        <textarea class="form-control" id="content_description" name="content_description" rows="3">
                            Testing file upload functionality with detailed logging.
                        </textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="attachment" class="form-label">Upload File</label>
                        <input type="file" class="form-control" id="attachment" name="attachment" 
                               accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.mp4,.zip">
                        <div class="form-text">Select a file to test upload functionality</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="max_file_size" class="form-label">Max File Size (MB)</label>
                        <input type="number" class="form-control" id="max_file_size" name="max_file_size" 
                               value="10" min="1" max="100">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Upload Content</button>
                    <button type="button" class="btn btn-secondary" onclick="testExistingFiles()">Test Existing Files</button>
                </form>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Upload Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="uploadResults">
                            <p class="text-muted">Results will appear here after upload...</p>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Debug Information</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugInfo">
                            <p class="text-muted">Debug info will appear here...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Content Items List</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshContentList()">
                            Refresh List
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="contentItemsList">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get CSRF token
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                   'LMTdeWTTXYQgdus6vdqT1O48ZbGm694VaoUchW3Y'; // Fallback token
        }
        
        document.getElementById('courseContentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const resultsDiv = document.getElementById('uploadResults');
            const debugDiv = document.getElementById('debugInfo');
            
            // Update token
            formData.set('_token', getCSRFToken());
            
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Uploading...';
            debugDiv.innerHTML = 'Processing upload...';
            
            // Debug form data
            let debugInfo = '<strong>Form Data:</strong><br>';
            for (let [key, value] of formData.entries()) {
                if (key === 'attachment' && value instanceof File) {
                    debugInfo += `${key}: ${value.name} (${value.size} bytes)<br>`;
                } else {
                    debugInfo += `${key}: ${value}<br>`;
                }
            }
            debugDiv.innerHTML = debugInfo;
            
            fetch('/admin/modules/course-content-store', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRF-TOKEN': getCSRFToken(),
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                
                if (data.success) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Success!</strong><br>
                            ${data.message}<br>
                            <small>Content ID: ${data.content_item?.id || 'Unknown'}</small>
                        </div>
                    `;
                    
                    // Show content item details
                    if (data.content_item) {
                        debugDiv.innerHTML += '<br><strong>Created Content Item:</strong><br>' +
                            JSON.stringify(data.content_item, null, 2).replace(/\n/g, '<br>');
                    }
                    
                    // Refresh content list
                    refreshContentList();
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error!</strong><br>
                            ${data.message || 'Upload failed'}
                        </div>
                    `;
                    
                    if (data.errors) {
                        debugDiv.innerHTML += '<br><strong>Errors:</strong><br>' +
                            JSON.stringify(data.errors, null, 2).replace(/\n/g, '<br>');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Network Error!</strong><br>
                        ${error.message}
                    </div>
                `;
            });
        });
        
        function refreshContentList() {
            const listDiv = document.getElementById('contentItemsList');
            listDiv.innerHTML = 'Loading...';
            
            fetch('/admin/modules/course-content-items/69/32', {
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.content_items) {
                    let html = '<table class="table table-sm"><thead><tr>' +
                              '<th>ID</th><th>Title</th><th>Type</th><th>Attachment</th><th>Created</th>' +
                              '</tr></thead><tbody>';
                    
                    data.content_items.forEach(item => {
                        html += `<tr>
                            <td>${item.id}</td>
                            <td>${item.content_title}</td>
                            <td><span class="badge bg-primary">${item.content_type}</span></td>
                            <td>${item.attachment_path || '<em>None</em>'}</td>
                            <td><small>${item.created_at}</small></td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<p class="text-muted">No content items found</p>';
                }
            })
            .catch(error => {
                console.error('Error loading content list:', error);
                listDiv.innerHTML = '<p class="text-danger">Error loading content list</p>';
            });
        }
        
        function testExistingFiles() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = 'Testing existing files...';
            
            // Test file accessibility
            const testFiles = [
                'content/1753101842_ARTC - DFD (1).pdf',
                'content/test_module_1753044980.pdf',
                'content/comprehensive_test_1753105115.pdf'
            ];
            
            let html = '<strong>File Accessibility Test:</strong><br>';
            
            testFiles.forEach(filePath => {
                const url = `/storage/${filePath}`;
                html += `Testing: ${filePath}<br>`;
                
                fetch(url, { method: 'HEAD' })
                    .then(response => {
                        const status = response.ok ? '✅ Accessible' : '❌ Not Found';
                        html += `&nbsp;&nbsp;${status} (${response.status})<br>`;
                        debugDiv.innerHTML = html;
                    })
                    .catch(error => {
                        html += `&nbsp;&nbsp;❌ Error: ${error.message}<br>`;
                        debugDiv.innerHTML = html;
                    });
            });
        }
        
        // Load content list on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshContentList();
        });
    </script>
    
    <meta name="csrf-token" content="LMTdeWTTXYQgdus6vdqT1O48ZbGm694VaoUchW3Y">
</body>
</html>
