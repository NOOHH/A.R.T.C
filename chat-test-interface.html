<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .message-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .message-form input {
            flex: 1;
        }
        .message-form button {
            margin: 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chat System Test Interface</h1>
        
        <div class="section">
            <h3>1. Session Setup</h3>
            <p>Simulate login by setting session data:</p>
            <select id="userRole">
                <option value="student">Student (ID: 1)</option>
                <option value="professor">Professor (ID: 8)</option>
                <option value="admin">Admin (ID: 1)</option>
            </select>
            <button onclick="setupSession()">Setup Session</button>
            <div id="sessionStatus" class="output"></div>
        </div>

        <div class="section">
            <h3>2. Get Users</h3>
            <p>Test retrieving available users for chat:</p>
            <select id="userType">
                <option value="all">All Users</option>
                <option value="student">Students</option>
                <option value="professor">Professors</option>
                <option value="admin">Admins</option>
                <option value="director">Directors</option>
            </select>
            <button onclick="getUsers()">Get Users</button>
            <div id="usersOutput" class="output"></div>
        </div>

        <div class="section">
            <h3>3. Get Messages</h3>
            <p>Test retrieving messages with a user:</p>
            <input type="number" id="withUserId" placeholder="User ID to get messages with" value="8">
            <button onclick="getMessages()">Get Messages</button>
            <div id="messagesOutput" class="output"></div>
        </div>

        <div class="section">
            <h3>4. Send Message</h3>
            <p>Test sending a message:</p>
            <div class="message-form">
                <input type="number" id="receiverId" placeholder="Receiver ID" value="8">
                <input type="text" id="messageContent" placeholder="Message content" value="Hello from test interface!">
                <button onclick="sendMessage()">Send Message</button>
            </div>
            <div id="sendOutput" class="output"></div>
        </div>

        <div class="section">
            <h3>5. Live Chat Test</h3>
            <p>Real-time chat interface:</p>
            <div id="chatMessages" class="output" style="height: 200px;"></div>
            <div class="message-form">
                <input type="text" id="liveMessage" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendLiveMessage()">
                <button onclick="sendLiveMessage()">Send</button>
                <button onclick="refreshMessages()">Refresh</button>
            </div>
        </div>
    </div>

    <script>
        const baseUrl = 'http://127.0.0.1:8080';
        let currentUserId = 1;
        let currentUserRole = 'student';
        let chatWithUserId = 8;

        // Get CSRF token
        async function getCsrfToken() {
            try {
                const response = await fetch(baseUrl + '/login');
                const text = await response.text();
                const match = text.match(/name="csrf-token" content="([^"]+)"/);
                return match ? match[1] : null;
            } catch (error) {
                console.error('Error getting CSRF token:', error);
                return null;
            }
        }

        async function setupSession() {
            const role = document.getElementById('userRole').value;
            const sessionData = {
                student: { user_id: 1, user_role: 'student', logged_in: true },
                professor: { user_id: 8, user_role: 'professor', logged_in: true },
                admin: { user_id: 1, user_role: 'admin', logged_in: true }
            };

            currentUserId = sessionData[role].user_id;
            currentUserRole = sessionData[role].user_role;
            
            document.getElementById('sessionStatus').textContent = 
                `Session set: ${JSON.stringify(sessionData[role], null, 2)}`;
            
            // Update chat with user ID
            document.getElementById('withUserId').value = currentUserId === 1 ? 8 : 1;
            document.getElementById('receiverId').value = currentUserId === 1 ? 8 : 1;
            chatWithUserId = currentUserId === 1 ? 8 : 1;
        }

        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(baseUrl + endpoint, options);
                const result = await response.json();
                
                return {
                    status: response.status,
                    data: result
                };
            } catch (error) {
                return {
                    status: 'error',
                    data: { error: error.message }
                };
            }
        }

        async function getUsers() {
            const type = document.getElementById('userType').value;
            const result = await apiCall(`/api/chat/session/users?type=${type}`);
            document.getElementById('usersOutput').textContent = JSON.stringify(result, null, 2);
        }

        async function getMessages() {
            const withUserId = document.getElementById('withUserId').value;
            const result = await apiCall(`/api/chat/session/messages?with=${withUserId}`);
            document.getElementById('messagesOutput').textContent = JSON.stringify(result, null, 2);
        }

        async function sendMessage() {
            const receiverId = document.getElementById('receiverId').value;
            const message = document.getElementById('messageContent').value;
            
            const result = await apiCall('/api/chat/session/send', 'POST', {
                receiver_id: receiverId,
                message: message
            });
            
            document.getElementById('sendOutput').textContent = JSON.stringify(result, null, 2);
            
            // Clear message input
            document.getElementById('messageContent').value = '';
        }

        async function sendLiveMessage() {
            const message = document.getElementById('liveMessage').value;
            if (!message.trim()) return;
            
            const result = await apiCall('/api/chat/session/send', 'POST', {
                receiver_id: chatWithUserId,
                message: message
            });
            
            document.getElementById('liveMessage').value = '';
            refreshMessages();
        }

        async function refreshMessages() {
            const result = await apiCall(`/api/chat/session/messages?with=${chatWithUserId}`);
            
            let output = `=== Chat with User ${chatWithUserId} ===\n`;
            if (result.data && result.data.data) {
                result.data.data.forEach(msg => {
                    const sender = msg.sender_id === currentUserId ? 'You' : `User ${msg.sender_id}`;
                    const time = new Date(msg.created_at).toLocaleTimeString();
                    output += `[${time}] ${sender}: ${msg.content}\n`;
                });
            } else {
                output += 'No messages or error occurred\n';
                output += JSON.stringify(result, null, 2);
            }
            
            document.getElementById('chatMessages').textContent = output;
        }

        // Initialize
        setupSession();
    </script>
</body>
</html>
