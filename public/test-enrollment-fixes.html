<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="test-token">
    <title>Enrollment Error Fixes Test</title>
    <script>
        const CSRF_TOKEN = "test-token";
        const isUserLoggedIn = false;
        
        // Test 1: OTP functionality test
        async function testOTPFunction() {
            console.log('=== Testing OTP Function ===');
            
            const email = 'test@example.com';
            
            try {
                const response = await fetch('/enrollment/send-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': CSRF_TOKEN
                    },
                    body: JSON.stringify({ email: email })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ OTP Response:', data);
                return data;
                
            } catch (error) {
                console.error('‚ùå OTP Error:', error);
                return null;
            }
        }
        
        // Test 2: Form field population test
        function testFormFieldPopulation() {
            console.log('=== Testing Form Field Population ===');
            
            // Simulate data from account step
            const userFirstname = 'Edward';
            const userLastname = 'Mckintyre';
            const userEmail = 'yorushetzu@gmail.com';
            
            const form = document.getElementById('testForm');
            if (!form) {
                console.error('‚ùå Test form not found');
                return false;
            }
            
            // Test field population logic from copyStepperDataToFinalForm
            const firstnameField = form.querySelector('input[name="firstname"]');
            if (firstnameField) {
                firstnameField.value = userFirstname;
                console.log('‚úÖ Populated firstname field with:', userFirstname);
                firstnameField.dataset.populated = 'true';
            } else {
                console.log('‚ö†Ô∏è No firstname field found in form');
            }
            
            const lastnameField = form.querySelector('input[name="lastname"]');
            if (lastnameField) {
                lastnameField.value = userLastname;
                console.log('‚úÖ Populated lastname field with:', userLastname);
                lastnameField.dataset.populated = 'true';
            } else {
                console.log('‚ö†Ô∏è No lastname field found in form');
            }
            
            // Check if fields are visible and have correct values
            setTimeout(() => {
                console.log('Final field check:');
                console.log('- Firstname value:', firstnameField?.value);
                console.log('- Lastname value:', lastnameField?.value);
                console.log('- Firstname visible:', firstnameField ? window.getComputedStyle(firstnameField).display !== 'none' : false);
                console.log('- Lastname visible:', lastnameField ? window.getComputedStyle(lastnameField).display !== 'none' : false);
            }, 100);
            
            return true;
        }
        
        // Test 3: CSRF token test
        function testCSRFToken() {
            console.log('=== Testing CSRF Token ===');
            
            const metaToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const constantToken = CSRF_TOKEN;
            
            console.log('Meta tag token:', metaToken);
            console.log('Constant token:', constantToken);
            console.log('Tokens match:', metaToken === constantToken);
            
            return metaToken && constantToken;
        }
        
        // Run all tests
        async function runAllTests() {
            console.log('üöÄ Starting Enrollment Error Fixes Test Suite');
            
            const csrfResult = testCSRFToken();
            const formResult = testFormFieldPopulation();
            const otpResult = await testOTPFunction();
            
            console.log('\n=== TEST RESULTS ===');
            console.log('CSRF Token Setup:', csrfResult ? '‚úÖ PASS' : '‚ùå FAIL');
            console.log('Form Field Population:', formResult ? '‚úÖ PASS' : '‚ùå FAIL');
            console.log('OTP Functionality:', otpResult ? '‚úÖ PASS' : '‚ùå FAIL');
            
            const allPassed = csrfResult && formResult && otpResult;
            console.log('\nOverall Result:', allPassed ? 'üéâ ALL TESTS PASSED' : '‚ö†Ô∏è SOME TESTS FAILED');
            
            return allPassed;
        }
        
        // Auto-run tests when page loads
        document.addEventListener('DOMContentLoaded', runAllTests);
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Enrollment Error Fixes Test</h1>
    <p>This page tests the fixes for enrollment errors. Check the browser console for detailed results.</p>
    
    <div class="test-section">
        <h2>Test Form (Simulates Step 7)</h2>
        <form id="testForm">
            <div class="form-group">
                <label for="firstname">First Name:</label>
                <input type="text" name="firstname" id="firstname" placeholder="Should be auto-filled">
            </div>
            <div class="form-group">
                <label for="lastname">Last Name:</label>
                <input type="text" name="lastname" id="lastname" placeholder="Should be auto-filled">
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" name="email" id="email" placeholder="Email address">
            </div>
        </form>
    </div>
    
    <div class="test-section">
        <h2>Manual Tests</h2>
        <button onclick="testFormFieldPopulation()">Test Form Population</button>
        <button onclick="testOTPFunction()">Test OTP Function</button>
        <button onclick="testCSRFToken()">Test CSRF Token</button>
    </div>
    
    <div class="test-section">
        <h2>Instructions</h2>
        <ol>
            <li>Open browser console (F12)</li>
            <li>Page will auto-run tests on load</li>
            <li>Look for "ALL TESTS PASSED" message</li>
            <li>If any tests fail, check the detailed error messages</li>
        </ol>
    </div>
</body>
</html>
