<!DOCTYPE html>
<html>
<head>
    <title>Final Analytics Fix Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .data-item { margin: 5px 0; padding: 5px; background: #f5f5f5; }
    </style>
</head>
<body>
    <h1>Final Analytics Fix Verification</h1>
    <div id="results">Loading...</div>
    
    <script>
    $.ajax({
        url: '/admin/analytics/data',
        type: 'GET',
        success: function(data) {
            let html = '<h2>Fix Verification Results:</h2>';
            
            // Test Board Passers
            html += '<div class="section"><h3>Board Passers Fix:</h3>';
            if (data.tables.boardPassers && data.tables.boardPassers.length > 0) {
                html += '<p class="success">✅ Found ' + data.tables.boardPassers.length + ' board passers</p>';
                let passer = data.tables.boardPassers[0];
                html += '<div class="data-item">';
                html += '<strong>Sample Board Passer:</strong><br>';
                html += 'Student: ' + passer.full_name + '<br>';
                html += 'Program: ' + passer.program_name + '<br>';
                html += 'Board Exam: ' + passer.board_exam + '<br>';
                html += 'Year: ' + passer.exam_year + '<br>';
                html += 'Result: ' + passer.result;
                html += '</div>';
                
                if (passer.full_name.includes('Vince') && passer.program_name !== 'N/A') {
                    html += '<p class="success">✅ Proper student name and program loaded!</p>';
                } else {
                    html += '<p class="error">❌ Still issues with data</p>';
                }
            } else {
                html += '<p class="error">❌ No board passers data found</p>';
            }
            html += '</div>';
            
            // Test Recently Completed
            html += '<div class="section"><h3>Recently Completed Fix:</h3>';
            if (data.tables.recentlyCompleted && data.tables.recentlyCompleted.length > 0) {
                html += '<p class="success">✅ Found ' + data.tables.recentlyCompleted.length + ' recently completed items</p>';
                
                data.tables.recentlyCompleted.forEach(function(completion, index) {
                    html += '<div class="data-item">';
                    html += '<strong>Completion ' + (index + 1) + ':</strong><br>';
                    html += 'Student: ' + completion.name + '<br>';
                    html += 'Program: ' + completion.program + '<br>';
                    html += 'Completion Date: ' + completion.completion_date + '<br>';
                    html += 'Details: ' + completion.final_score;
                    html += '</div>';
                });
                
                if (data.tables.recentlyCompleted.some(c => c.name.includes('Vince'))) {
                    html += '<p class="success">✅ Your completed courses/modules are showing!</p>';
                } else {
                    html += '<p class="info">ℹ️ No completions found for "Vince" - check if student name matches</p>';
                }
            } else {
                html += '<p class="error">❌ No recently completed data found</p>';
            }
            html += '</div>';
            
            // Test Export Fix
            html += '<div class="section"><h3>Export Fix Test:</h3>';
            html += '<button onclick="testExport()" class="btn btn-primary">Test PDF Export</button>';
            html += '<div id="exportResult"></div>';
            html += '</div>';
            
            $('#results').html(html);
        },
        error: function(xhr, status, error) {
            $('#results').html('<div class="error">Error loading analytics: ' + error + '</div>');
        }
    });
    
    function testExport() {
        $('#exportResult').html('<p class="info">Testing export...</p>');
        
        // Test export URL
        const exportUrl = '/admin/analytics/export?format=pdf';
        window.open(exportUrl, '_blank');
        
        $('#exportResult').html('<p class="success">✅ Export opened - check if it loads without errors</p>');
    }
    </script>
</body>
</html>
