<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Referral Field Display</title>
    <meta name="csrf-token" content="dummy-token">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .form-group { margin: 15px 0; }
        .form-control { width: 300px; padding: 8px; border: 1px solid #ccc; }
        .btn { padding: 8px 16px; background: #007bff; color: white; border: none; cursor: pointer; }
        .status-message { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .referral-input-group { position: relative; display: inline-block; }
        .referral-input-group .btn-otp { position: absolute; right: 2px; top: 2px; bottom: 2px; background: #28a745; border: none; color: white; padding: 0 10px; border-radius: 3px; cursor: pointer; }
        .test-results { background: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Referral Field Display Test</h1>
    
    <div class="test-results">
        <h3>Settings Status:</h3>
        <p><strong>Referral Enabled:</strong> <span id="enabledStatus">Loading...</span></p>
        <p><strong>Referral Required:</strong> <span id="requiredStatus">Loading...</span></p>
    </div>

    <!-- Simulate the referral field from signup.blade.php -->
    <div id="referralFieldContainer">
        <h3>Referral Code Field Test:</h3>
        <div class="form-group">
            <label for="referral_code">
                Referral Code 
                <span id="requiredAsterisk" style="display: none; color: red;">*</span>
            </label>
            <div class="referral-input-group">
                <input type="text" id="referral_code" name="referral_code" 
                       class="form-control"
                       placeholder="Enter referral code (e.g., PROF01JOHN)" 
                       value="">
                <button type="button" id="validateReferralBtn" class="btn-otp" onclick="validateReferralCodeSignup()">
                    <i class="fas fa-check"></i> Validate
                </button>
            </div>
            <div id="referralCodeError" class="status-message status-error" style="display: none;"></div>
            <div id="referralCodeSuccess" class="status-message status-success" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Check settings from database simulation
        fetch('/A.R.T.C/api/test-referral-settings')
            .then(response => response.json())
            .then(data => {
                const enabled = data.referral_enabled === '1';
                const required = data.referral_required === '1';
                
                document.getElementById('enabledStatus').textContent = enabled ? 'YES (Field should show)' : 'NO (Field should hide)';
                document.getElementById('requiredStatus').textContent = required ? 'YES (Field is required)' : 'NO (Field is optional)';
                
                // Show/hide field based on settings
                const container = document.getElementById('referralFieldContainer');
                if (enabled) {
                    container.style.display = 'block';
                    if (required) {
                        document.getElementById('requiredAsterisk').style.display = 'inline';
                        document.getElementById('referral_code').setAttribute('required', 'required');
                    }
                } else {
                    container.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error checking settings:', error);
                document.getElementById('enabledStatus').textContent = 'Error loading settings';
                document.getElementById('requiredStatus').textContent = 'Error loading settings';
            });

        // Referral code validation function
        function validateReferralCodeSignup() {
            const referralInput = document.getElementById('referral_code');
            const referralCode = referralInput.value.trim().toUpperCase();
            const validateBtn = document.getElementById('validateReferralBtn');
            const errorDiv = document.getElementById('referralCodeError');
            const successDiv = document.getElementById('referralCodeSuccess');
            
            // Clear previous messages
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';
            
            if (!referralCode) {
                showReferralMessage('Please enter a referral code', 'error');
                return;
            }
            
            // Show loading state
            validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            validateBtn.disabled = true;
            
            // Make AJAX request to validate referral code
            fetch('/A.R.T.C/api/validate-referral-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': 'dummy-token'
                },
                body: JSON.stringify({
                    referral_code: referralCode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    showReferralMessage(`Valid referral code from ${data.referrer_name} (${data.referrer_type})`, 'success');
                    referralInput.classList.add('is-valid');
                    referralInput.classList.remove('is-invalid');
                    referralInput.value = referralCode; // Ensure uppercase
                } else {
                    showReferralMessage(data.message || 'Invalid referral code', 'error');
                    referralInput.classList.add('is-invalid');
                    referralInput.classList.remove('is-valid');
                }
            })
            .catch(error => {
                console.error('Error validating referral code:', error);
                showReferralMessage('Error validating referral code. Please try again.', 'error');
                referralInput.classList.add('is-invalid');
                referralInput.classList.remove('is-valid');
            })
            .finally(() => {
                // Reset button state
                validateBtn.innerHTML = '<i class="fas fa-check"></i> Validate';
                validateBtn.disabled = false;
            });
        }
        
        function showReferralMessage(message, type) {
            const targetDiv = type === 'success' ? 
                document.getElementById('referralCodeSuccess') : 
                document.getElementById('referralCodeError');
            
            if (targetDiv) {
                targetDiv.textContent = message;
                targetDiv.style.display = 'block';
            }
        }
    </script>
</body>
</html>
