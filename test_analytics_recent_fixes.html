<!DOCTYPE html>
<html>
<head>
    <title>Test Recent Completions</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Analytics Fixes Test</h1>
    <div id="results">Loading...</div>
    
    <script>
    $.ajax({
        url: '/admin/analytics/data',
        type: 'GET',
        success: function(data) {
            let html = '<h2>Test Results:</h2>';
            
            // Test Board Passers
            html += '<div class="section"><h3>Board Passers Fix:</h3>';
            if (data.tables.boardPassers.length > 0) {
                let passer = data.tables.boardPassers[0];
                html += '<p>Sample board passer:</p>';
                html += '<ul>';
                html += '<li>Student: ' + (passer.full_name || 'N/A') + '</li>';
                html += '<li>Program: ' + (passer.program_name || 'N/A') + '</li>';
                html += '<li>Board Exam: ' + (passer.board_exam || 'N/A') + '</li>';
                html += '<li>Year: ' + (passer.exam_year || 'N/A') + '</li>';
                html += '</ul>';
                
                if (passer.full_name === 'Unknown Student' || passer.program_name === 'Unknown Program') {
                    html += '<p class="error">❌ Still showing "Unknown" values</p>';
                } else {
                    html += '<p class="success">✅ Proper student/program names loaded</p>';
                }
            } else {
                html += '<p class="info">No board passers data found</p>';
            }
            html += '</div>';
            
            // Test Recently Completed
            html += '<div class="section"><h3>Recently Completed Fix:</h3>';
            if (data.tables.recentlyCompleted.length > 0) {
                html += '<p class="success">✅ Found ' + data.tables.recentlyCompleted.length + ' recently completed students</p>';
                let completion = data.tables.recentlyCompleted[0];
                html += '<p>Sample completion:</p>';
                html += '<ul>';
                html += '<li>Student: ' + (completion.name || 'N/A') + '</li>';
                html += '<li>Program: ' + (completion.program || 'N/A') + '</li>';
                html += '<li>Completion Date: ' + (completion.completion_date || 'N/A') + '</li>';
                html += '<li>Final Score: ' + (completion.final_score || 'N/A') + '</li>';
                html += '</ul>';
            } else {
                html += '<p class="info">No recently completed students found - check if any students have high progress (90%+) or completed status</p>';
            }
            html += '</div>';
            
            // Test Student Count
            html += '<div class="section"><h3>Student Count Fix:</h3>';
            html += '<p>Total Students: <strong>' + data.metrics.totalStudents + '</strong></p>';
            if (data.charts.progressDistribution) {
                html += '<p>Progress Distribution Chart:</p>';
                html += '<ul>';
                html += '<li>Labels: ' + JSON.stringify(data.charts.progressDistribution.labels) + '</li>';
                html += '<li>Data: ' + JSON.stringify(data.charts.progressDistribution.data) + '</li>';
                html += '</ul>';
                
                if (data.charts.progressDistribution.labels.length > 0 && 
                    data.charts.progressDistribution.data.some(val => val > 0)) {
                    html += '<p class="success">✅ Student distribution chart has data</p>';
                } else {
                    html += '<p class="info">Student distribution chart is empty (expected if no students)</p>';
                }
            }
            html += '</div>';
            
            $('#results').html(html);
        },
        error: function(xhr, status, error) {
            $('#results').html('<div class="error">Error loading analytics: ' + error + '</div>');
        }
    });
    </script>
</body>
</html>
