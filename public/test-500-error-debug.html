<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Modular Enrollment Test - 500 Error Debug</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">ðŸš¨ 500 Error Debug Test</h1>
        
        <div class="alert alert-warning">
            <h5>Issue Identified:</h5>
            <p><strong>Error:</strong> "Too few arguments to function Illuminate\Http\Request::hasFile(), 0 passed"</p>
            <p><strong>Status:</strong> FIXED - Updated hasFile() to check allFiles() instead</p>
            <p><strong>Testing:</strong> Graduate level registration that was failing with 500 error</p>
        </div>

        <form id="quickTest" class="border p-4 rounded">
            <input type="hidden" name="_token" value="">
            
            <h4>Graduate Level Test (Files Optional)</h4>
            
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Education Level</label>
                    <select name="education_level" class="form-select" required>
                        <option value="Graduate">Graduate</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Program ID</label>
                    <input type="number" name="program_id" class="form-control" value="33" required>
                </div>
            </div>
            
            <div class="row mt-2">
                <div class="col-md-6">
                    <label class="form-label">Package ID</label>
                    <input type="number" name="package_id" class="form-control" value="18" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Learning Mode</label>
                    <select name="learning_mode" class="form-select" required>
                        <option value="synchronous">Synchronous</option>
                    </select>
                </div>
            </div>
            
            <div class="row mt-2">
                <div class="col-md-6">
                    <label class="form-label">Start Date</label>
                    <input type="date" name="Start_Date" class="form-control" value="2025-07-20" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Enrollment Type</label>
                    <select name="enrollment_type" class="form-select" required>
                        <option value="Modular">Modular</option>
                    </select>
                </div>
            </div>
            
            <input type="hidden" name="selected_modules" value='[{"id":46,"name":"Test Module","selected_courses":["11","14"]}]'>
            <input type="hidden" name="plan_id" value="2">
            
            <div class="mt-3">
                <h5>Account Information</h5>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">First Name</label>
                        <input type="text" name="user_firstname" class="form-control" value="Debug" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Last Name</label>
                        <input type="text" name="user_lastname" class="form-control" value="Test" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" value="debug.test@example.com" required>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label class="form-label">Password</label>
                        <input type="password" name="password" class="form-control" value="password123" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" name="password_confirmation" class="form-control" value="password123" required>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <h5>File Uploads (All Optional for Graduate)</h5>
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">School ID <small class="text-muted">(Optional)</small></label>
                        <input type="file" name="school_id" class="form-control" accept="image/*">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">TOR <small class="text-muted">(Optional)</small></label>
                        <input type="file" name="tor" class="form-control" accept=".pdf">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Good Moral <small class="text-muted">(Optional)</small></label>
                        <input type="file" name="good_moral" class="form-control" accept=".pdf">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Diploma <small class="text-muted">(Optional)</small></label>
                        <input type="file" name="diploma" class="form-control" accept=".pdf">
                    </div>
                </div>
            </div>
            
            <button type="button" onclick="submitDebugTest()" class="btn btn-primary mt-4">
                ðŸ§ª Test Fixed Registration (Should Work Now)
            </button>
        </form>

        <div id="result" class="mt-4" style="display: none;">
            <h4>Test Result:</h4>
            <pre id="resultContent" class="bg-light p-3 rounded"></pre>
        </div>
    </div>

    <script>
        function submitDebugTest() {
            const form = document.getElementById('quickTest');
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            // Get or generate CSRF token
            let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (!csrfToken) {
                // Try to fetch from any hidden input
                const tokenInput = document.querySelector('input[name="_token"]');
                if (tokenInput) {
                    csrfToken = tokenInput.value;
                }
            }
            
            const formData = new FormData(form);
            if (csrfToken) {
                formData.set('_token', csrfToken);
            }
            
            resultDiv.style.display = 'block';
            resultContent.textContent = 'Submitting test (should not get 500 error now)...';
            
            fetch('/A.R.T.C/enrollment/modular/submit', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                return response.text().then(text => {
                    try {
                        const data = JSON.parse(text);
                        return { status: response.status, data, raw: text };
                    } catch (e) {
                        return { status: response.status, data: null, raw: text };
                    }
                });
            })
            .then(result => {
                const { status, data, raw } = result;
                
                let message = `Status: ${status}\n\n`;
                
                if (status === 200 || status === 201) {
                    message += 'âœ… SUCCESS! Registration completed.\n\n';
                    message += JSON.stringify(data, null, 2);
                } else if (status === 422) {
                    message += 'âš ï¸ VALIDATION ERROR (Expected for testing)\n\n';
                    message += JSON.stringify(data, null, 2);
                } else if (status === 500) {
                    message += 'âŒ 500 INTERNAL SERVER ERROR (Bug not fixed)\n\n';
                    message += raw;
                } else {
                    message += `â„¹ï¸ OTHER RESPONSE (${status})\n\n`;
                    message += raw;
                }
                
                resultContent.textContent = message;
            })
            .catch(error => {
                resultContent.textContent = `âŒ NETWORK ERROR\n\n${error.message}`;
            });
        }
        
        // Auto-fetch CSRF token when page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/A.R.T.C/csrf-token', { 
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.csrf_token) {
                    document.querySelector('input[name="_token"]').value = data.csrf_token;
                }
            })
            .catch(() => {
                console.warn('Could not fetch CSRF token');
            });
        });
    </script>
</body>
</html>
